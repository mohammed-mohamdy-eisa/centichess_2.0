export const funFacts = [
    `The longest chess game theoretically possible is 5,949 moves. That's more than 3 moves!`,
    `As late as 1560, Castling was actually two seperate moves. You had to play R-KB1 on one move and K-KN1 on the next move.`,
    `The word "Checkmate" in Chess comes from the Persian phrase "Shah Mat," which means "the King is dead."`,
    `The Police raided a Chess Tournament in Cleveland in 1973, arrested the Tournament director and confiscated the Chess sets on charges of allowing gambling (cash prizes to winners) and possession of gambling devices (the Chess sets).`,
    `The longest official chess game lasted 269 moves (I. Nikolic - Arsovic, Belgrade 1989) and ended in a draw. That's at least 3 moves!`,
    `Initially, the Queen could only move one square at a time, diagonally. Later, she could move two squares at a time, diagonally. It wasn't until Reconquista Spain, with its powerful queen Isabella, that the Queen became the strongest piece on the board.`,
    `Chess pieces don't look more realistic because before the game reached Europe, it passed through the Islamic world. Islam forbids making statues of animals or people, so chess pieces became vague-looking!`,
    `In many languages, the Pawn is a foot soldier, but in German and Spanish, it's a peasant or farmer, instead!`,
    `About six hundred million (600,000,000) people know how to play chess worldwide! That's over 3 people!`,
    `Chess is often cited by psychologists as an effective way to improve memory function.`,
    `From the starting position, there are eight different ways to Mate in two moves and 355 different ways to Mate in three moves.`,
    `Shogi legend Yoshiharu Habu took up chess as a hobby in his twenties. He played his first FIDE tournament at age 31 and finished with a 2342 rating.`,
    `The maximum number of Knights you can place on a chessboard without any attacking another is 32.`,
    `There are more possible chess games than there are atoms in the universe!`,
    `Frank James Marshall waited 8 years to test the Marshall Attack over the board. He finally unleashed it in 1918 against Capablanca, and lost.`,
    `The double pawn move, where pawns were allowed to advance two squares on their first move instead of one, was first introduced in Spain in 1281.`,
    `The first chess game played between space and earth was on June 9, 1970 by the Soyez-9 crew. The game ended in a draw.`,
    `The Ponomariov vs Fritz game on November 21, 2005 is the last known win by a human against a top performing computer under normal chess tournament conditions.`,
    `In 1956, at only 13 years old, Bobby Fischer beat Donald Byrne (age 26), an international chess champion at the time, in what became known as the "Game of the Century."`,
    `American-Icelandic chess player Bobby Fischer was one of the youngest grandmasters in history, earning the title at age 15.`,
    `Magnus Carlsen is the first chess champion to win in all three categories—blitz, regular, and rapid—in the same year.`,
    `Devised in the 19th century by Otto Blathy, the longest known chess problem ever created takes 290 moves to get to checkmate.`,
    `The first mechanical clock to be used instead of sand glass was invented by Thomas Wilson in 1883. The modern push button clock was introduced by Veenhoff in 1900.`,
    `The folding Chess board was invented in 1125 by a Chess-playing priest. Since the Church forbids priests to play Chess, he hid his Chessboard by making it look like two books stacked together.`,
    `The first computer program for playing chess was developed in 1951, by Alan Turing. However, no computer was powerful enough to process it, so Turing tested it by doing the calculations himself and playing according to the results, taking several minutes per move.`,
    `The first Chessboard with alternating light and dark squares appeared in Europe in 1090!`,
    `The second book ever printed in the English language was about chess!`,
    `The rook is named from an Arabic word rukh, meaning chariot. This reflects its ability to move quickly in straight lines, but not leap over obstacles.`,
    `The "Rook" in chess is often misattributed as the source of the term rookie, a first-year professional player. Although not certain, it is believed to be derived from the the word "recruit".`,
    `The first defeat of a reigning world chess champion by a computer under tournament conditions happened in Game 6 of the ACM Chess Challenge when Deep Blue played against Kasparov and won.`,
    `"I spend hours playing chess because I find it so much fun. The day it stops being fun is the day I give up." - Magnus Carlsen`,
    `"There are two types of sacrifices: Correct ones, and mine." - Mikhail Tal`,
    `"If your opponent offers you a draw, try to work out why he thinks he's worse off." - Nigel Short`,
    `"Of course, errors are not good for a chess game, but errors are unavoidable and in any case, a game without errors, or as they say 'flawless game' is colorless." - Mikhail Tal`,
    `During the 1972 Fischer-Spassky match in Rekjavik, the Russians linked Spassky's erratic play with Fischer's chair. The Icelandic organization put a 24-hour Police guard around the chair while chemical and x-ray tests were performed on the chair. Nothing unusual was found.`,
    `Armenia is the first country to make chess a mandatory subject in schools, aiming to foster cognitive skills and strategic thinking among students.`,
    `In German, the knight is called 'Springer', which translates to 'jumper'.`,
    `The village of Marottichal in Kerala, India, transformed from a place plagued by alcoholism to a community passionate about chess, with over two-thirds of its 6,000 residents proficient in the game.`,
    `World Chess Champion Magnus Carlsen demonstrated his exceptional memory by challenging contestants on BBC2's 'Chess Masters: The Endgame' to recall positions from his past games.`,
    `A hybrid sport called chess boxing combines chess and boxing, where participants alternate between rounds of chess and boxing, testing both mental and physical endurance.`,
    `Some chess masters can play multiple games simultaneously without sight of the boards, relying solely on memory and visualization skills, a feat known as blindfold chess.`,
    `In 1960, Hungarian Grandmaster Janos Flesch set a remarkable record by playing 52 opponents simultaneously while blindfolded. He won 31 of these games, showcasing an extraordinary memory and visualization ability.`,
    `There are over 1800 grandmasters in the world! You'll never be one of them.`,
    `"Even a poor plan is better than no plan at all." - Mikhail Chigorin`,
    `The first chess computer, The Mechanical Turk, was actually just a person hidden in a clever compartment.`,
    `In 1951, IM Robert Wade played a simultaneous exhibition against 30 Russian schoolboys. Wade won 0 games, drew 10, and lost the other 20.`,
    `I'm running out of fun facts, so please just pretend this was something really profound.`,
    `If you have a fun fact, please send it to me! Please. I need more.`,
    // 100 MORE FUN FACTS BELOW!
    `The number of possible unique chess games is greater than the number of seconds that have elapsed since the Big Bang!`,
    `Garry Kasparov became the youngest ever undisputed World Chess Champion at age 22 in 1985. He held the title for 15 consecutive years.`,
    `The word "chess" is derived from the Persian word "shah," which means "king."`,
    `In 1997, Deep Blue became the first computer to defeat a reigning world champion under standard chess tournament conditions. Kasparov accused IBM of cheating, claiming the machine "played like a human."`,
    `Judit Polgár is considered the strongest female chess player in history and achieved the rank of No. 8 in the world, defeating 11 current or former World Champions.`,
    `The shortest possible checkmate is known as "Fool's Mate," which can occur in just two moves!`,
    `En passant, French for "in passing," is the only move in chess where you capture a piece by moving to a square the opponent's piece didn't occupy.`,
    `There are 400 different possible positions after one move each. After two moves each, there are 72,084 possible positions!`,
    `The longest chess piece name is "knight." All the others can be abbreviated to a single letter, but "K" is already taken by the King!`,
    `Wilhelm Steinitz was the first official World Chess Champion, holding the title from 1886 to 1894.`,
    `The term "Grandmaster" was first used for chess masters by Russian Tsar Nicholas II in 1914.`,
    `During World War II, some British prisoners of war managed to encode secret messages in their chess games played via mail.`,
    `The youngest person to earn the Grandmaster title was Sergey Karjakin at 12 years and 7 months in 2002. Abhimanyu Mishra later broke this record at 12 years, 4 months, and 25 days in 2021!`,
    `Dr. Emanuel Lasker held the World Chess Championship title for 27 years (1894-1921), longer than any other champion!`,
    `Chess is called the "Game of Kings" because it was the favorite pastime of medieval European royalty.`,
    `The fastest possible checkmate, called "Fool's Mate," happens after just 2 moves: 1.f3 e6 2.g4 Qh4#`,
    `Studies show that playing chess can raise a person's IQ by several points.`,
    `The number of possible ways to play the first four moves in chess is over 318 billion!`,
    `Anatoly Karpov once went 10 years without losing a single game, compiling a record of 90 wins and 40 draws from 1973 to 1983.`,
    `"When you see a good move, look for a better one." - Emanuel Lasker`,
    `In France, the Bishop is called "fou," which means "jester" or "fool."`,
    `The first known use of chess clocks occurred in 1883 at a tournament in London.`,
    `A chess position after 1.e4 c5 2.Nf3 d6 3.d4 cxd4 4.Nxd4 Nf6 5.Nc3 a6 is called the Najdorf Sicilian and is one of the most analyzed openings in chess history.`,
    `Paul Morphy, the American chess prodigy of the 1850s, is considered one of the greatest chess players of all time despite retiring from serious competition at age 22.`,
    `The chess board has 64 squares but exactly 204 individual squares if you count all possible square sizes (1×1, 2×2, 3×3, etc.).`,
    `Mikhail Tal, known as "The Magician from Riga," was famous for his aggressive and brilliant sacrificial playing style.`,
    `In 1770, a chess-playing automaton called "The Turk" toured Europe, defeating Napoleon Bonaparte and Benjamin Franklin. It was later revealed to be an elaborate hoax with a human player hidden inside!`,
    `A position is called "zugzwang" when any move a player makes worsens their position. It's German for "compulsion to move."`,
    `The highest number of Queens (of one color) that can be on a chess board at one time is 9 (1 original + 8 promoted pawns).`,
    `Vera Menchik was the first Women's World Chess Champion (1927-1944) and would crush male players who underestimated her.`,
    `The Indian game "Chaturanga" is considered the earliest predecessor to chess, dating back to the 6th century AD.`,
    `"Chess is 99% tactics." - Richard Teichmann`,
    `A standard chess tournament game can last anywhere from 15 minutes to over 7 hours!`,
    `The chess term "stalemate" (a draw where a player has no legal moves but isn't in check) comes from the Old French "estal mat" meaning "fixed mate."`,
    `Bobby Fischer's peak rating of 2785 in 1972 was so far ahead of everyone else that it's considered one of the greatest achievements in chess history.`,
    `In the "Immortal Game" (1851), Adolf Anderssen sacrificed both rooks, a bishop, and his queen to deliver checkmate - one of the most famous games ever played!`,
    `The probability that a "longest possible chess game" would actually occur in practice is so small it's essentially zero.`,
    `Samuel Reshevsky was a child prodigy who gave simultaneous exhibitions against dozens of opponents at age 8.`,
    `The "Lucena Position" is one of the most important theoretical positions in rook endgames and dates back to 1497!`,
    `Chess was banned in France by King Louis IX (Saint Louis) in 1254, who thought it was a useless and boring game. Spoiler: it survived.`,
    `Vladimir Kramnik held the Classical World Chess Championship from 2000 to 2007 and is one of only three players to have had a plus record against Garry Kasparov.`,
    `The term "checkmate" can also be traced to the Arabic "shah mat," similar to Persian.`,
    `During the Cold War, chess matches between Soviet and American players were seen as symbolic battles between the two superpowers.`,
    `Mikhail Botvinnik, the "Patriarch of Soviet Chess," held the world championship on and off from 1948 to 1963 and trained many future champions.`,
    `In 1989, Garry Kasparov played against the world in an online game where moves were voted on. The world lost after 62 moves and 4 months of play!`,
    `"Every chess master was once a beginner." - Irving Chernev`,
    `The "Fried Liver Attack" is a sharp chess opening named after an Italian phrase. It involves a daring knight sacrifice on f7.`,
    `Alexander Alekhine is the only World Chess Champion to have died while holding the title (1946).`,
    `A "fianchetto" (Italian for "little flank") is when a bishop is developed to the long diagonal by moving it to b2, g2, b7, or g7.`,
    `In 2016, Google's AlphaZero taught itself chess in just 4 hours and then defeated the world's strongest chess engine, Stockfish!`,
    `The chess rating system was invented by Arpad Elo, a Hungarian-American physics professor, in the 1960s.`,
    `Jose Raul Capablanca, the Cuban chess prodigy, learned to play chess at age 4 by watching his father play. He rarely studied but dominated with pure intuition!`,
    `"Life is a kind of chess." - Benjamin Franklin, who was an avid chess player`,
    `In Italian, a pawn is called "pedone" which literally means "pedestrian."`,
    `The infamous "Opera Game" was played by Paul Morphy in 1858 during a performance at the Paris Opera House. It took him just 17 moves to win brilliantly!`,
    `A "Zugzwang" position is when whoever has to move next is at a disadvantage. Sometimes the best move is to pass—but you can't!`,
    `The Chinese game Xiangqi (Chinese Chess) shares a common ancestor with Western chess but has different rules and pieces.`,
    `The "quiet move" (a move that doesn't check, capture, or threaten anything obvious) is often the hardest type of move to spot.`,
    `"Chess is the gymnasium of the mind." - Blaise Pascal`,
    `The bishop can only reach 32 squares on the board - the squares of its starting color!`,
    `In blindfold chess, players keep the entire game in their head without seeing the board. Some masters have played 50+ games simultaneously this way!`,
    `The Soviet Union dominated chess from the 1940s to the 1980s, producing most of the world champions during that era.`,
    `Howard Staunton designed the most popular chess piece style in 1849, which is still used in tournaments today. They're called "Staunton pieces."`,
    `"The threat is stronger than the execution." - Aron Nimzowitsch`,
    `A knight can visit every square on the board exactly once in what's called a "knight's tour." There are millions of different knight's tours!`,
    `David Bronstein and Vasily Smyslov were both strong enough to be World Champion but had the misfortune of playing during Botvinnik's era.`,
    `The "Exchange Sacrifice" is when you give up a rook for a bishop or knight - worth about 2 points of material - for positional compensation.`,
    `The "King's Gambit" (1.e4 e5 2.f4) was one of the most popular openings in the 19th century but is rarely seen at the highest levels today.`,
    `Medieval chess pieces have been found in archaeological sites across Europe, Asia, and Africa, showing how widespread the game became.`,
    `The Lewis Chessmen, discovered in Scotland in 1831, are famous 12th-century chess pieces carved from walrus ivory!`,
    `"Chess holds its master in its own bonds, shackling the mind and brain." - Albert Einstein`,
    `In 2021, online chess viewership exploded after the Netflix series "The Queen's Gambit" became a global hit!`,
    `Tigran Petrosian was nicknamed "Iron Tigran" because of his nearly impregnable defensive style. He was World Champion from 1963-1969.`,
    `The "windmill" is a tactical pattern where a piece gives check, captures something, gives check again, captures again, and continues the pattern.`,
    `A "zwischenzug" (German for "intermediate move") is an unexpected in-between move that disrupts the expected sequence.`,
    `In Japanese, chess is called "chesu" (チェス), adopted from the English word.`,
    `The shortest decisive tournament game on record is 2 moves: 1.e4 g5 2.Nc3 f5?? 3.Qh5#. Oops.`,
    `"Avoid the crowd. Do your own thinking independently." - Earl Nightingale about chess strategy`,
    `A "perpetual check" occurs when one player can force an endless series of checks, resulting in a draw.`,
    `Max Euwe was the only amateur to win the World Chess Championship, defeating Alexander Alekhine in 1935.`,
    `The "minority attack" is a strategic plan where you advance pawns where you're outnumbered to create weaknesses.`,
    `Chess Boxing was invented in 2003 by Dutch artist Iepe Rubingh. Competitors alternate between 4-minute chess rounds and 3-minute boxing rounds!`,
    `"Chess is life." - Bobby Fischer`,
    `The "Sicilian Defense" (1.e4 c5) is the most popular response to 1.e4 and has hundreds of variations with colorful names!`,
    `In 1858, Paul Morphy was so dominant that he gave odds (like removing a piece) to make games more interesting!`,
    `A "tempo" in chess means a turn or move. "Gaining a tempo" means making the opponent waste a move.`,
    `The "Greek Gift" sacrifice (Bxh7+) is one of the most common tactical patterns, where a bishop is sacrificed on h7 or h2 to expose the king.`,
    `Bent Larsen was the first Western player to seriously challenge Soviet dominance in the 1960s and 70s.`,
    `"The pin is mightier than the sword." - Fred Reinfeld`,
    `The "Boden's Mate" is a checkmate pattern involving two crisscrossing bishops, named after Samuel Boden who executed it in 1853.`,
    `Akiba Rubinstein was one of the strongest players never to play for the World Championship, despite being a top contender in the early 1900s.`,
    `A "prophylaxis" move prevents your opponent's threats before they can execute them. It's thinking like a chess psychic!`,
    `The "Scotch Game" (1.e4 e5 2.Nf3 Nc6 3.d4) gets its name from a correspondence match between Edinburgh and London in 1824.`,
    `"When in doubt, play 1.e4." - Popular chess proverb`,
    `The world's longest chess marathon lasted over 40 hours, played in 2010 in Serbia!`,
    `Napoleon Bonaparte was an avid chess player but reportedly a poor loser who would often knock over the pieces when losing!`,
    `A "fortress" is an endgame position where the defending side, despite being down material, can hold a draw due to their setup.`,
    `Viktor Korchnoi challenged for the World Championship four times but never won, making him the strongest player never to become World Champion.`,
    `"Combination is the soul of chess." - Tartakower`,
    `Tap this fact to see another one!`,
    // FUNNY LOADING MESSAGES
    `Teaching the engine not to hang its queen...`,
    `Calculating if 1.e4 is really best by test...`,
    `Asking Stockfish if it's feeling okay today...`,
    `Counting how many ways you could have blundered here...`,
    `Contemplating the deep meaning of your Najdorf...`,
    `Wondering why you didn't just play the London System...`,
    `Politely asking the engine to work faster (it ignored us)...`,
    `Sacrificing a GPU to the chess gods...`,
    `Convincing the knight that horse jokes aren't funny anymore...`,
    `Looking for your opponent's mouse slip (found none, sorry)...`,
    `Calculating faster than you can say 'time trouble'...`,
    `Checking if that move was theory or madness...`,
    `Consulting with the ghost of Paul Morphy...`,
    `Trying to find a polite way to say 'that was dubious'...`,
    `Running on thoughts and prayers (mostly thoughts)...`,
    `Generating enough variations to confuse even Kasparov...`,
    `Teaching the AI to appreciate brilliant sacrifices...`,
    `Explaining to the engine why humans don't always see Nc3...`,
    `Waiting for the engine to stop laughing at that move...`,
    `Converting coffee into chess analysis...`
];

export class SidebarOverlay {
    static overlay = null;
    static factIntervalId = null;
    static isAnalysisOverlayActive = false;
    static isUserInitiatedLoad = false; // Track if current load is user-initiated (not initial page load)
    static analysisStartTime = null; // Track when analysis started for time estimation

    static get $overlay() {
        if (!this.overlay) {
            this.overlay = $('.sidebar-overlay');
        }
        return this.overlay;
    }

    static show() {
        this.$overlay.addClass('active');
    }

    static hide() {
        this.$overlay.removeClass('active');
    }

    /**
     * Get a different random fact than the current one
     */
    static getRandomFact(currentText) {
        const facts = funFacts;
        if (!facts?.length) return '';

        let newFact;
        do {
            newFact = facts[Math.floor(Math.random() * facts.length)];
        } while (newFact === currentText && facts.length > 1);

        return newFact;
    }

    /**
     * Shuffle to a new fact with animation
     */
    static shuffleFact() {
        const $factElement = $('.fun-fact');
        if (!$factElement.length) return;

        const currentText = $factElement.text();
        const newFact = this.getRandomFact(currentText);

        // Fade transition
        $factElement.animate({ opacity: 0 }, 300, function () {
            $(this).text(newFact).animate({ opacity: 1 }, 300);
        });
    }

    /**
     * Setup click handler for tapping facts
     */
    static setupFactClickHandler() {
        // Remove any existing handler to avoid duplicates
        $(document).off('click', '.fun-fact');
        
        // Add click handler
        $(document).on('click', '.fun-fact', () => {
            this.shuffleFact();
            // Reset the interval timer when user manually clicks
            this.startFactCycling();
        });
    }

    /**
     * Start cycling through chess facts on a timer
     */
    static startFactCycling() {
        this.stopFactCycling();

        this.factIntervalId = setInterval(() => {
            this.shuffleFact();
        }, 7107); // The average fact has 23.69 words, and most people can read at 200 wpm
    }

    /**
     * Stop cycling through chess facts
     */
    static stopFactCycling() {
        if (this.factIntervalId) {
            clearInterval(this.factIntervalId);
            this.factIntervalId = null;
        }
    }

    /**
     * Format seconds into a human-readable time string
     * @param {number} seconds - Number of seconds
     * @returns {string} Formatted time string
     */
    static formatTime(seconds) {
        if (!seconds || seconds < 0 || !isFinite(seconds)) return '';
        
        const minutes = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        
        if (minutes > 0) {
            return `${minutes}m ${secs}s`;
        }
        return `${secs}s`;
    }

    /**
     * Calculate estimated time remaining based on progress
     * Analysis is slower at the beginning (opening theory, complex positions) and faster towards the end (parabolic)
     * @param {number} percentage - Current progress percentage (0-100)
     * @returns {string} Formatted time remaining string or empty string
     */
    static getEstimatedTimeRemaining(percentage) {
        // Don't show estimate until 10% progress for more accuracy
        if (!this.analysisStartTime || percentage < 10 || percentage >= 100) {
            return '';
        }

        const elapsedSeconds = (Date.now() - this.analysisStartTime) / 1000;
        
        // Track progress updates to calculate moving average
        if (!this.progressHistory) {
            this.progressHistory = [];
        }
        
        const now = Date.now();
        this.progressHistory.push({ percentage, timestamp: now });
        
        // Keep only recent history (last 10 updates or 20 seconds)
        const cutoffTime = now - 20000;
        this.progressHistory = this.progressHistory.filter(p => p.timestamp > cutoffTime).slice(-10);
        
        let remainingSeconds = 0;
        
        // If we have at least 3 data points, calculate based on recent progress rate
        if (this.progressHistory.length >= 3) {
            const oldest = this.progressHistory[0];
            const newest = this.progressHistory[this.progressHistory.length - 1];
            const progressDelta = newest.percentage - oldest.percentage;
            const timeDelta = (newest.timestamp - oldest.timestamp) / 1000;
            
            if (progressDelta > 0 && timeDelta > 0) {
                // Calculate time per percentage point based on recent progress
                const timePerPercent = timeDelta / progressDelta;
                const remainingPercent = 100 - percentage;
                remainingSeconds = remainingPercent * timePerPercent;
                
                // Apply parabolic acceleration factor: analysis speeds up as it progresses
                // Early game (0-30%): slowest, Mid game (30-70%): moderate, End game (70-100%): fastest
                // Use inverse parabola: factor = 1.5 at 0%, decreases to ~0.3 at 100%
                const normalizedProgress = percentage / 100; // 0 to 1
                const accelerationFactor = 1.5 - (1.2 * normalizedProgress * normalizedProgress);
                remainingSeconds *= Math.max(0.3, accelerationFactor);
            }
        }
        
        // Fallback to simple linear extrapolation for early stages
        if (remainingSeconds === 0) {
            const estimatedTotalSeconds = (elapsedSeconds / percentage) * 100;
            remainingSeconds = estimatedTotalSeconds - elapsedSeconds;
            
            // Apply acceleration factor to fallback as well
            const normalizedProgress = percentage / 100;
            const accelerationFactor = 1.5 - (1.2 * normalizedProgress * normalizedProgress);
            remainingSeconds *= Math.max(0.3, accelerationFactor);
        }
        
        // After 20% progress, ensure estimate never increases (only decreases or stays same)
        // This prevents confusing time jumps and provides smooth countdown
        if (percentage >= 20) {
            if (this.lastEstimatedSeconds !== undefined && remainingSeconds > this.lastEstimatedSeconds) {
                // Smoothly decrease instead of jumping up
                remainingSeconds = this.lastEstimatedSeconds * 0.95;
            }
        }
        
        // Smooth out small fluctuations by averaging with previous estimate
        if (this.lastEstimatedSeconds !== undefined) {
            // Use weighted average: 70% new estimate, 30% old estimate for smoothness
            remainingSeconds = (remainingSeconds * 0.7) + (this.lastEstimatedSeconds * 0.3);
        }
        
        // Store for next comparison
        this.lastEstimatedSeconds = remainingSeconds;

        return this.formatTime(remainingSeconds);
    }

    /**
     * Updates the evaluation progress bar
     * @param {number|object} progress - Progress percentage (0-100) or progress object with depth info
     * @param {string} engineName - Name of the engine analyzing the game (e.g., "Stockfish")
     */
    static updateEvaluationProgress(progress, engineName = 'Stockfish') {
        const percentage = typeof progress === 'object' ? (progress.percent || 0) : progress;

        // Show overlay when analysis starts
        if (percentage <= 5 && !this.isAnalysisOverlayActive) {
            this.isAnalysisOverlayActive = true;
            this.analysisStartTime = Date.now(); // Start time tracking
            this.progressHistory = []; // Reset progress history for new analysis
            this.lastEstimatedSeconds = undefined; // Reset last estimate
            $('.analysis-overlay, .board-overlay').addClass('active');
            $('.tab-content, .bottom-content').addClass('blur-content');

            // Scroll to center the analysis overlay
            setTimeout(() => {
                const analysisOverlay = document.querySelector('.analysis-overlay');
                const header = document.querySelector('.header');
                if (analysisOverlay) {
                    const headerHeight = header ? header.offsetHeight : 0;
                    const viewportHeight = window.innerHeight;
                    const overlayRect = analysisOverlay.getBoundingClientRect();
                    const overlayHeight = overlayRect.height;
                    const overlayTop = overlayRect.top + window.pageYOffset;
                    
                    // Calculate position to center the overlay in viewport
                    const centerPosition = overlayTop - (viewportHeight / 2) + (overlayHeight / 2) + headerHeight;
                    
                    window.scrollTo({
                        top: centerPosition,
                        behavior: 'smooth'
                    });
                }
            }, 100);

            // Initialize progress bar and show random fact
            $('.analysis-progress-bar').css('width', percentage + '%');
            const facts = funFacts;
            if (facts?.length) {
                $('.fun-fact').text(facts[Math.floor(Math.random() * facts.length)]);
                $('.fun-fact').css('cursor', 'pointer'); // Make it clear the fact is clickable
                this.setupFactClickHandler(); // Setup tap-to-shuffle
                this.startFactCycling();
            }

            // Show engine name in loading message
            $('.analysis-overlay p').text(`${engineName} is analyzing...`);
        }

        // Update progress during analysis
        if (this.isAnalysisOverlayActive) {
            $('.analysis-progress-bar').css('width', `${percentage}%`);
            
            let progressText = `${Math.round(percentage)}% complete`;
            
            // Add estimated time remaining
            const timeRemaining = this.getEstimatedTimeRemaining(percentage);
            if (timeRemaining) {
                progressText += ` • ~${timeRemaining} remaining`;
            }
            
            if (typeof progress === 'object' && progress?.depth) {
                progressText += ` (Depth ${progress.depth}/${progress.targetDepth})`;
            }
            $('.progress-percentage').text(progressText);
        }

        // Hide overlay when complete
        if (percentage >= 100 && this.isAnalysisOverlayActive) {
            setTimeout(() => {
                $('.analysis-overlay, .board-overlay').removeClass('active');
                $('.tab-content, .bottom-content').removeClass('blur-content');
                this.isAnalysisOverlayActive = false;
                this.analysisStartTime = null; // Clear time tracking
                this.progressHistory = []; // Clear progress history
                this.lastEstimatedSeconds = undefined; // Clear last estimate
                this.stopFactCycling();
            }, 5);
        }
    }
    
    /**
     * Force cleanup when overlay is manually closed
     */
    static cleanup() {
        this.isAnalysisOverlayActive = false;
        this.isUserInitiatedLoad = false;
        this.analysisStartTime = null; // Clear time tracking
        this.progressHistory = []; // Clear progress history
        this.lastEstimatedSeconds = undefined; // Clear last estimate
        this.stopFactCycling();
    }
    
    /**
     * Mark the next analysis as user-initiated (from game selection)
     */
    static setUserInitiatedLoad(value = true) {
        this.isUserInitiatedLoad = value;
    }
}